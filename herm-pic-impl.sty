%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% TeX macro package herm-pic
%
% LaTeX class for drawing HERM diagramms.
%
%  HERM-Pic is a LaTeX class for drawing HERM diagramms. Its written
%  on the basis of a privat package from Bernhard Thalheim. Its aim is
%  to offer a comfortable way to draw HERM diagramms, with less
%  limitations to the processibility of the consisting tex document.
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Package Implemantation
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Option Handling
%
\newif\ifherm@verbatim \herm@verbatimfalse%
\newif\ifherm@centerschema \herm@centerschemafalse%
\newif\ifherm@boxschema \herm@boxschemafalse%
%
\DeclareOption{verbatim}{%
  \herm@verbatimtrue%
}%
\DeclareOption{center}{%
  \herm@centerschematrue%
  \ifherm@verbatim%
    \PackageInfo{herm-pic}{ * center schema}
  \fi%
}%
\DeclareOption{box}{%
  \herm@boxschematrue%
  \ifherm@verbatim%
    \PackageInfo{herm-pic}{ * put schema in a box}
  \fi%
}%
\DeclareOption*{
  \PackageWarning{herm-pic}{Unknown option '\CurrentOption'.}%
}%
\ProcessOptions\relax%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Global Definitions
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% scaling
%
\global\newdimen{\hermunit}
\setlength{\hermunit}{.5cm}
\newdimen{\herm@tempul}
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Schema elements
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% ---  schema environment  ---
%
% \begin{schema}(x,y)
\def\schema(#1,#2){%
  \setlength{\herm@tempul}{\unitlength}
  \setlength{\unitlength}{\hermunit}
  \ifherm@centerschema
    \begin{center}
  \fi
  \begin{picture}(#1,#2)
}%
%
% \end{schema}
\def\endschema{
  \end{picture}
  \ifherm@centerschema
    \end{center}
  \fi
  \setlength{\unitlength}{\herm@tempul}
}%
%
% ---  Entity  ---
%
% \entity(x,y){name}
%
% Hoehe: 2 LE Breite: 4 LE
\def\entity{%
  \futurelet\entityLockedAt\entityDecide
}%
\def\entityDecide{%
  \ifx\entityLockedAt *%
    \let\next=\entityb
  \else
    \let\next=\entitya
  \fi
  \next
}%
\def\entitya(#1,#2)#3{%
  \ifherm@verbatim%
    \PackageInfo{herm-pic}{Process entity \string#3 ...}%
  \fi%
  \put(#1,#2){%
    \put(0,0){\line(1,0){4}}%
    \put(4,0){\line(0,1){2}}%
    \put(4,2){\line(-1,0){4}}%
    \put(0,0){\line(0,1){2}}%
    \put(0,0){\makebox(4,2){#3}}%
  }%
  \global\expandafter\def\csname hermobjx@#3 \endcsname{#1}%
  \global\expandafter\def\csname hermobjy@#3 \endcsname{#2}%
  \global\expandafter\def\csname hermobj@#3 \endcsname{1}%
  \global\expandafter\def\csname herment@#3 \endcsname{1}%
}%
\def\entityb *(#1,#2)#3{%
  \ifherm@verbatim%
    \PackageInfo{herm-pic}{Process entity \string#3 ...}%
  \fi%
  \put(#1,#2){%
    \put(0,0){\line(1,0){4}}%
    \put(4,0){\line(0,1){2}}%
    \put(4,2){\line(-1,0){4}}%
    \put(0,0){\line(0,1){2}}%
    \put(0,0){\makebox(4,2){#3}}%
  }%
}%
%
% ---  Relation  ---
%
% \relation(x,y){name}
%
% Hoehe 2LE Breite 4LE
\def\relation{%
  \futurelet\relLockedAt\relDecide
}%
\def\relDecide{%
  \ifx\relLockedAt *%
    \let\next=\relationb
  \else
    \let\next=\relationa
  \fi
  \next
}%
\def\relationa(#1,#2)#3{%
  \ifherm@verbatim%
    \PackageInfo{herm-pic}{Process relation \string#3 ...}%
  \fi%
  \put(#1,#2){%
    \put(2,2){\line(-2,-1){2}}%
    \put(2,2){\line(2,-1){2}}%
    \put(2,0){\line(2,1){2}}%
    \put(2,0){\line(-2,1){2}}%
    \put(0,0){\makebox(4,2){#3}}%
  }%
  \global\expandafter\def\csname hermobjx@#3 \endcsname{#1}%
  \global\expandafter\def\csname hermobjy@#3 \endcsname{#2}%
  \global\expandafter\def\csname hermobj@#3 \endcsname{1}%
  \global\expandafter\def\csname hermrel@#3 \endcsname{1}%
}%
\def\relationb *(#1,#2)#3{%
  \ifherm@verbatim%
    \PackageInfo{herm-pic}{Process relation \string#3 ...}%
  \fi%
  \put(#1,#2){%
    \put(2,2){\line(-2,-1){2}}%
    \put(2,2){\line(2,-1){2}}%
    \put(2,0){\line(2,1){2}}%
    \put(2,0){\line(-2,1){2}}%
    \put(0,0){\makebox(4,2){#3}}%
  }%
}%
%
% ---  Cluster  ---
%
% \cluster(x,y)
%
% defines the cluster representation
% width = 2
% height = 2
%
% a circle width a plus in it
\def\cluster{%
  \futurelet\clusterLockedAt\clusterDecide
}%
\def\clusterDecide{%
  \ifx\clusterLockedAt *%
    \let\next=\clusterb
  \else
    \let\next=\clustera
  \fi
  \next
}%
\def\clustera(#1,#2)#3{%
  \ifherm@verbatim%
    \PackageInfo{herm-pic}{Process cluster \string#3 ...}%
  \fi% 
  \put(#1,#2){%
    \put(1,1){%
      \qbezier(-1,0)(-1,.4)(-.7,.7)%
      \qbezier(-.7,.7)(-.4,1)(0,1)%
      \qbezier(0,1)(.4,1)(.7,.7)%
      \qbezier(.7,.7)(1,.4)(1,0)%
      \qbezier(1,0)(1,-.4)(.7,-.7)%
      \qbezier(.7,-.7)(.4,-1)(0,-1)%
      \qbezier(0,-1)(-.4,-1)(-.7,-.7)%
      \qbezier(-.7,-.7)(-1,-.4)(-1,0)%
    }%
    \put(1,.3){\line(0,1){1.4}}%
    \put(.3,1){\line(1,0){1.4}}%
    \put(2,2){\makebox(1,1)[bl]{#3}}%
  }%
  \global\expandafter\def\csname hermobjx@#3 \endcsname{#1}%
  \global\expandafter\def\csname hermobjy@#3 \endcsname{#2}%
  \global\expandafter\def\csname hermobj@#3 \endcsname{1}%
  \global\expandafter\def\csname hermcluster@#3 \endcsname{1}%
}%
\def\clusterb *(#1,#2)#3{%
  \ifherm@verbatim%
    \PackageInfo{herm-pic}{Process cluster \string#3 ...}%
  \fi% 
  \put(#1,#2){%
    \put(1,1){
      \qbezier(-1,0)(-1,.4)(-.7,.7)%
      \qbezier(-.7,.7)(-.4,1)(0,1)%
      \qbezier(0,1)(.4,1)(.7,.7)%
      \qbezier(.7,.7)(1,.4)(1,0)%
      \qbezier(1,0)(1,-.4)(.7,-.7)%
      \qbezier(.7,-.7)(.4,-1)(0,-1)%
      \qbezier(0,-1)(-.4,-1)(-.7,-.7)%
      \qbezier(-.7,-.7)(-1,-.4)(-1,0)%
    }%
    \put(1,.3){\line(0,1){1.4}}%
    \put(.3,1){\line(1,0){1.4}}%
    \put(2,2){\makebox(1,1)[bl]{#3}}%
  }%
}%
%
% ---  Attributes ---
%
% puts attributes to objects.
%
% \attr[pos]{object}{name} or
% \attr*[pos](x,y){name}
\newcount\herm@tsx \newcount\herm@tsy
\def\attr{%
  \futurelet\attrLockedAt\attrDecide
}%
\def\attrDecide{%
  \ifx\attrLockedAt *%
    \let\next=\attrb
  \else
    \let\next=\attra
  \fi
  \next
}%
\def\attra[#1]#2#3{%
  \ifherm@verbatim%
    \PackageInfo{herm-pic}{Process attribute \string#3 on \string#2 ...}%
  \fi%
  \newif\ifherm@conerr \herm@conerrtrue
  \expandafter\if\csname hermobj@#2 \endcsname 1%
    \ifherm@verbatim%
      \PackageInfo{herm-pic}{   object \string#2 found}%
    \fi%
    \herm@conerrfalse%
    \herm@tsx=\csname hermobjx@#2 \endcsname%
    \herm@tsy=\csname hermobjy@#2 \endcsname%
    \ifherm@verbatim%
      \PackageInfo{herm-pic}{      with \the\herm@tsx, \the\herm@tsy}%
    \fi%
  \fi%
  \ifherm@conerr%
    \PackageError {herm-pic}{Undefined object #2 in addvanced attribute}{See herm-pic documentation}%
  \fi%
  % prepare attribute placement
  \def\herm@inpos{#1}%
  \def\herm@or{or} \def\herm@ol{ol} \def\herm@ur{ur} \def\herm@ul{ul}%
  \def\herm@ro{ro} \def\herm@ru{ru} \def\herm@lo{lo} \def\herm@lu{lu}%
  \def\herm@om{om} \def\herm@rm{rm} \def\herm@lm{lm} \def\herm@um{um}%
  % compute attribute drawing
  \expandafter\if\csname herment@#2 \endcsname 1%
    \ifx\herm@inpos\herm@ol \put(\herm@tsx,\herm@tsy){\put(.5,2){\put(0,0){\line(0,1){.5}} \put(0,0.6){\makebox(0,0)[b]{$#3$}}}}%
    \else
      \ifx\herm@inpos\herm@or \put(\herm@tsx,\herm@tsy){\put(3.5,2){\put(0,0){\line(0,1){.5}} \put(0,0.6){\makebox(0,0)[b]{$#3$}}}}%
      \else
        \ifx\herm@inpos\herm@ro \put(\herm@tsx,\herm@tsy){\put(4,1.5){\put(0,0){\line(1,0){.5}} \put(0.6,0){\makebox(0,0)[l]{$#3$}}}}%
        \else
          \ifx\herm@inpos\herm@ru \put(\herm@tsx,\herm@tsy){\put(4,.5){\put(0,0){\line(1,0){.5}} \put(0.6,0){\makebox(0,0)[l]{$#3$}}}}%
          \else
            \ifx\herm@inpos\herm@ur \put(\herm@tsx,\herm@tsy){\put(3.5,0){\put(0,0){\line(0,-1){.5}} \put(0,-.6){\makebox(0,0)[t]{$#3$}}}}%
            \else
              \ifx\herm@inpos\herm@ul \put(\herm@tsx,\herm@tsy){\put(.5,0){\put(0,0){\line(0,-1){.5}} \put(0,-.6){\makebox(0,0)[t]{$#3$}}}}%
              \else
                \ifx\herm@inpos\herm@lu \put(\herm@tsx,\herm@tsy){\put(0,.5){\put(0,0){\line(-1,0){.5}} \put(-.6,0){\makebox(0,0)[r]{$#3$}}}}%
                \else
                  \ifx\herm@inpos\herm@lo \put(\herm@tsx,\herm@tsy){\put(0,1.5){\put(0,0){\line(-1,0){.5}} \put(-.6,0){\makebox(0,0)[r]{$#3$}}}}%
                  \else
                    \ifx\herm@inpos\herm@om \put(\herm@tsx,\herm@tsy){\put(2,2){\put(0,0){\line(0,1){.5}} \put(0,0.6){\makebox(0,0)[b]{$#3$}}}}%
                    \else
                      \ifx\herm@inpos\herm@rm \put(\herm@tsx,\herm@tsy){\put(4,1){\put(0,0){\line(1,0){.5}} \put(0.6,0){\makebox(0,0)[l]{$#3$}}}}%
                      \else
                        \ifx\herm@inpos\herm@um \put(\herm@tsx,\herm@tsy){\put(2,0){\put(0,0){\line(0,-1){.5}} \put(0,-.6){\makebox(0,0)[t]{$#3$}}}}%
                        \else
                          \ifx\herm@inpos\herm@lm \put(\herm@tsx,\herm@tsy){\put(0,1){\put(0,0){\line(-1,0){.5}} \put(-.6,0){\makebox(0,0)[r]{$#3$}}}}%
                          \else
                            \PackageWarning{herm-pic}{%
                              Undefind attribute positioning parameter #1
                              \MessageBreak have to come from or, om, ol, ur, um, ul, ro, rm, ru, lo, lm, lu (or as default).
                              \MessageBreak Using default [or].
                            }%
                            \attr[or]{#2}{#3}%
                          \fi%
                        \fi%
                      \fi%
                    \fi%
                  \fi%
                \fi%
              \fi%
            \fi%
          \fi%
        \fi%
      \fi%
    \fi%
  \fi%
  \expandafter\if\csname hermrel@#2 \endcsname 1%
    \ifx\herm@inpos\herm@ol \put(\herm@tsx,\herm@tsy){\put(1,1.5){\put(0,0){\line(0,1){.5}} \put(0,0.6){\makebox(0,0)[rb]{$#3$}}}}%
    \else
      \ifx\herm@inpos\herm@or \put(\herm@tsx,\herm@tsy){\put(3,1.5){\put(0,0){\line(0,1){.5}} \put(0,0.6){\makebox(0,0)[lb]{$#3$}}}}%
      \else
        \ifx\herm@inpos\herm@ro \put(\herm@tsx,\herm@tsy){\put(3,1.5){\put(0,0){\line(1,0){.5}} \put(0.6,0){\makebox(0,0)[l]{$#3$}}}}%
        \else
          \ifx\herm@inpos\herm@ru \put(\herm@tsx,\herm@tsy){\put(3,.5){\put(0,0){\line(1,0){.5}} \put(0.6,0){\makebox(0,0)[l]{$#3$}}}}%
          \else
            \ifx\herm@inpos\herm@ur \put(\herm@tsx,\herm@tsy){\put(3,.5){\put(0,0){\line(0,-1){.5}} \put(0,-.6){\makebox(0,0)[lt]{$#3$}}}}%
            \else
              \ifx\herm@inpos\herm@ul \put(\herm@tsx,\herm@tsy){\put(1,.5){\put(0,0){\line(0,-1){.5}} \put(0,-.6){\makebox(0,0)[rt]{$#3$}}}}%
              \else
                \ifx\herm@inpos\herm@lu \put(\herm@tsx,\herm@tsy){\put(1,.5){\put(0,0){\line(-1,0){.5}} \put(-.6,0){\makebox(0,0)[r]{$#3$}}}}%
                \else
                  \ifx\herm@inpos\herm@lo \put(\herm@tsx,\herm@tsy){\put(1,1.5){\put(0,0){\line(-1,0){.5}} \put(-.6,0){\makebox(0,0)[r]{$#3$}}}}%
                  \else
                    \ifx\herm@inpos\herm@om \put(\herm@tsx,\herm@tsy){\put(2,2){\put(0,0){\line(0,1){.5}} \put(0,0.6){\makebox(0,0)[b]{$#3$}}}}%
                    \else
                      \ifx\herm@inpos\herm@rm \put(\herm@tsx,\herm@tsy){\put(4,1){\put(0,0){\line(1,0){.5}} \put(0.6,0){\makebox(0,0)[l]{$#3$}}}}%
                      \else
                        \ifx\herm@inpos\herm@um \put(\herm@tsx,\herm@tsy){\put(2,0){\put(0,0){\line(0,-1){.5}} \put(0,-.6){\makebox(0,0)[t]{$#3$}}}}%
                        \else
                          \ifx\herm@inpos\herm@lm \put(\herm@tsx,\herm@tsy){\put(0,1){\put(0,0){\line(-1,0){.5}} \put(-.6,0){\makebox(0,0)[r]{$#3$}}}}%
                          \else
                            \PackageWarning{herm-pic}{%
                              Undefind attribute positioning parameter #1
                              \MessageBreak have to come from or, om, ol, ur, um, ul, ro, rm, ru, lo, lm, lu (or as default).
                              \MessageBreak Using default [or].
                            }%
                            \attr[or]{#2}{#3}%
                          \fi%
                        \fi%
                      \fi%
                    \fi%
                  \fi%
                \fi%
              \fi%
            \fi%
          \fi%
        \fi%
      \fi%
    \fi%
  \fi%
  \expandafter\if\csname hermcluster@#2 \endcsname 1%
    \ifx\herm@inpos\herm@ol \put(\herm@tsx,\herm@tsy){\put(.3,1.7){\put(0,0){\line(0,1){.5}} \put(0,0.6){\makebox(0,0)[rb]{$#3$}}}}%
    \else
      \ifx\herm@inpos\herm@or \put(\herm@tsx,\herm@tsy){\put(1.7,1.7){\put(0,0){\line(0,1){.5}} \put(0,0.6){\makebox(0,0)[lb]{$#3$}}}}%
      \else
        \ifx\herm@inpos\herm@ro \put(\herm@tsx,\herm@tsy){\put(1.7,1.7){\put(0,0){\line(1,0){.5}} \put(0.6,0){\makebox(0,0)[l]{$#3$}}}}%
        \else
          \ifx\herm@inpos\herm@ru \put(\herm@tsx,\herm@tsy){\put(1.7,.3){\put(0,0){\line(1,0){.5}} \put(0.6,0){\makebox(0,0)[l]{$#3$}}}}%
          \else
            \ifx\herm@inpos\herm@ur \put(\herm@tsx,\herm@tsy){\put(1.7,.3){\put(0,0){\line(0,-1){.5}} \put(0,-.6){\makebox(0,0)[lt]{$#3$}}}}%
            \else
              \ifx\herm@inpos\herm@ul \put(\herm@tsx,\herm@tsy){\put(.3,.3){\put(0,0){\line(0,-1){.5}} \put(0,-.6){\makebox(0,0)[rt]{$#3$}}}}%
              \else
                \ifx\herm@inpos\herm@lu \put(\herm@tsx,\herm@tsy){\put(.3,.3){\put(0,0){\line(-1,0){.5}} \put(-.6,0){\makebox(0,0)[r]{$#3$}}}}%
                \else
                  \ifx\herm@inpos\herm@lo \put(\herm@tsx,\herm@tsy){\put(.3,1.7){\put(0,0){\line(-1,0){.5}} \put(-.6,0){\makebox(0,0)[r]{$#3$}}}}%
                  \else
                    \ifx\herm@inpos\herm@om \put(\herm@tsx,\herm@tsy){\put(1,2){\put(0,0){\line(0,1){.5}} \put(0,0.6){\makebox(0,0)[b]{$#3$}}}}%
                    \else
                      \ifx\herm@inpos\herm@rm \put(\herm@tsx,\herm@tsy){\put(2,1){\put(0,0){\line(1,0){.5}} \put(0.6,0){\makebox(0,0)[l]{$#3$}}}}%
                      \else
                        \ifx\herm@inpos\herm@um \put(\herm@tsx,\herm@tsy){\put(1,0){\put(0,0){\line(0,-1){.5}} \put(0,-.6){\makebox(0,0)[t]{$#3$}}}}%
                        \else
                          \ifx\herm@inpos\herm@lm \put(\herm@tsx,\herm@tsy){\put(0,1){\put(0,0){\line(-1,0){.5}} \put(-.6,0){\makebox(0,0)[r]{$#3$}}}}%
                          \else
                            \PackageWarning{herm-pic}{%
                              Undefind attribute positioning parameter #1
                              \MessageBreak have to come from or, om, ol, ur, um, ul, ro, rm, ru, lo, lm, lu (or as default).
                              \MessageBreak Using default [or].
                            }%
                            \attr[or]{#2}{#3}%
                          \fi%
                        \fi%
                      \fi%
                    \fi%
                  \fi%
                \fi%
              \fi%
            \fi%
          \fi%
        \fi%
      \fi%
    \fi%
  \fi%
}%
\def\attrb *[#1](#2,#3)#4{%
  \ifherm@verbatim%
    \PackageInfo{herm-pic}{Process attribute \string#4 on (#2,#3) ...}%
  \fi%
  \def\herm@pos{#1} \def\herm@r{r} \def\herm@l{l} \def\herm@o{o} \def\herm@u{u}%
  \ifx\herm@pos\herm@r \put(#2,#3){\put(0,0){\line(1,0){.5}} \put(0.6,0){\makebox(0,0)[l]{$#4$}}}%
  \else
    \ifx\herm@pos\herm@l \put(#2,#3){\put(0,0){\line(-1,0){.5}} \put(-.6,0){\makebox(0,0)[r]{$#4$}}}%
    \else
      \ifx\herm@pos\herm@o \put(#2,#3){\put(0,0){\line(0,1){.5}} \put(0,0.6){\makebox(0,0)[b]{$#4$}}}%
      \else
        \ifx\herm@pos\herm@u \put(#2,#3){\put(0,0){\line(0,-1){.5}} \put(0,-.6){\makebox(0,0)[t]{$#4$}}}%
        \else
          \PackageWarning{herm-pic}{%
            Undefind attribute positioning parameter #1 \MessageBreak have to come from r,l,o,u (r as default).
           \MessageBreak Using default [r].
          }%
          \attr*[r](#2,#3){#4}%
        \fi%
      \fi%
    \fi%
  \fi%
}%
%

