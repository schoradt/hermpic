% Higher Entity Relationship Modell TeX Style
\def\HPDate $#1 #2 #3${#2}
\def\HPAuthor $#1 #2${#2}
\def\HPRev $#1 #2 ${#2}

\def\HERMpicId{\HPDate $Date: 2003-07-30 23:26:10 $ higher entity relationship diagramms }

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{herm-pic}[\HERMpicId]

\typeout{HERM-Pic <\HPRev $Revision: 1.17.2.1 $> \HERMpicId by \HPAuthor $Author: sven $}
%
% This package provide some graphical elements to draw 
% HER Modells.
%
% ---  package wide definitions  ---
%
\global\newdimen{\hermunit}
\newdimen{\herm@tempul}
% ---  set \hermunit to standard value  ---
\setlength{\hermunit}{.5cm} 
% ---  schema environment  ---
%
% \begin{schema}(x,y)
\def\schema(#1,#2){%
  \setlength{\herm@tempul}{\unitlength}
  \setlength{\unitlength}{\hermunit}
  \begin{picture}(#1,#2)
}%
%
% \end{schema}
\def\endschema{
  \end{picture}
  \setlength{\unitlength}{\herm@tempul}
}%
%
% ---  Entity  ---
%
% \entity(x,y){name}
%
% Hoehe: 2 LE Breite: 4 LE
\def\entity(#1,#2)#3{%
  \typeout{Doing entity \string#3 ...}%
  \put(#1,#2){%
    \put(0,0){\line(1,0){4}}%
    \put(4,0){\line(0,1){2}}%
    \put(4,2){\line(-1,0){4}}%
    \put(0,0){\line(0,1){2}}%
    \put(0,0){\makebox(4,2){#3}}%
  }%
  \edef\herm@oname{#3}
  \global\expandafter\def\csname hermobjx@#3 \endcsname{#1}%
  \global\expandafter\def\csname hermobjy@#3 \endcsname{#2}%
  \global\expandafter\def\csname hermobj@#3 \endcsname{1}%
%  \global\expandafter\newif\csname ifhermobj@\herm@oname{} \endcsname%
%  \global\expandafter\let
%     \csname ifhermobj@\herm@oname{}true \endcsname 
%     \iftrue%
  \expandafter\if\csname hermobj@#3 \endcsname 1%
    \typeout{!!! True !!! (\string#3)}
  \fi
}%
%
% ---  Relation  ---
%
% \relation(x,y){name}
%
% Hoehe 2LE Breite 4LE
\def\relation(#1,#2)#3{%
  \typeout{Doing relation #3 ...}%
  \put(#1,#2){%
    \put(2,2){\line(-2,-1){2}}%
    \put(2,2){\line(2,-1){2}}%
    \put(2,0){\line(2,1){2}}%
    \put(2,0){\line(-2,1){2}}%
    \put(0,0){\makebox(4,2){#3}}%
  }%
  \edef\herm@oname{\string#3}
  \global\expandafter\def\csname hermobjx@\string#3 \endcsname{#1}%
  \global\expandafter\def\csname hermobjy@\string#3 \endcsname{#2}%
  \global\expandafter\def\csname hermobj@\string#3 \endcsname{1}%
%  \global\expandafter\newif\csname ifhermobj@\herm@oname{} \endcsname%
%  \global\expandafter\let
%     \csname ifhermobj@\herm@oname{}true \endcsname 
%     \iftrue%
  \expandafter\if\csname hermobj@\string#3 \endcsname 1%
    \typeout{!!! True !!! (\string#3)}
  \fi

 }%
%
% ---  Cluster  ---
%
% \cluster(x,y)
%
% defines the cluster representation
% width = 2
% height = 2
%
% a circle width a plus in it
\def\cluster(#1,#2){%
  \put(#1,#2){%
    \put(1,1){\circle{2}}%
    \put(1,.3){\line(0,1){1.4}}%
    \put(.3,1){\line(1,0){1.4}}%
  }%
}%
%
% ---  Attributes  ---
%
% \attr(x,y)[pos]{name}
% where pos is from rlou
%
% the start point is the point where the attribut line docks on the
% object.
\def\attr(#1,#2)[#3]#4{%
  \def\herm@pos{#3} \def\herm@r{r} \def\herm@l{l} \def\herm@o{o} \def\herm@u{u}%
  \ifx\herm@pos\herm@r \put(#1,#2){\put(0,0){\line(1,0){.5}} \put(0.6,0){\makebox(0,0)[l]{$#4$}}}%
  \else
    \ifx\herm@pos\herm@l \put(#1,#2){\put(0,0){\line(-1,0){.5}} \put(-.6,0){\makebox(0,0)[r]{$#4$}}}%
    \else
      \ifx\herm@pos\herm@o \put(#1,#2){\put(0,0){\line(0,1){.5}} \put(0,0.6){\makebox(0,0)[b]{$#4$}}}%
      \else
        \ifx\herm@pos\herm@u \put(#1,#2){\put(0,0){\line(0,-1){.5}} \put(0,-.6){\makebox(0,0)[t]{$#4$}}}%
        \else
        \PackageWarning{herm-pic}{%
          Undefind attribute positioning parameter #1 \MessageBreak have to come from r,l,o,u (r as default).
          \MessageBreak Using default [r].
        }%
        \attr(#1,#2)[r]{#4}%
        \fi%
      \fi%
    \fi%
  \fi%
}%
%
% --- Key marking of attribute values ---
%
% marks an attribute or an attribute part as a key.
%
% \key{attribute}
%
\def\key#1{\underline{#1}}%
%
% ---  Connection  ---
%
% Draws an arrow from the start to the endpoint and places the label
% an a 'good' place.
%
% \connection(x1,y1)(x2,y2){label}
\newcount\herm@sx \newcount\herm@sy \newcount\herm@ex \newcount\herm@ey%
\newcount\herm@dx \newcount\herm@dy%
\newcount\herm@nsx \newcount\herm@nsy%
\newcount\herm@newx \newcount\herm@newy \newcount\herm@dxdy%
\newcount\herm@length%
%
\def\connection(#1,#2)(#3,#4)#5{%
  \herm@sx=#1%
  \herm@sy=#2%
  \herm@ex=#3%
  \herm@ey=#4%
  % try to compute \vector parameter
  \herm@dx=\herm@ex \herm@dy=\herm@ey%
  \herm@nsx=\herm@sx \multiply\herm@nsx by -1 \herm@nsy=\herm@sy \multiply\herm@nsy by -1%
  \advance\herm@dx by \herm@nsx \advance\herm@dy by \herm@nsy%
  \ifnum\herm@dy = 0 \ifnum\herm@dx > 0 \herm@newx=1 \else \herm@newx=-1 \fi \herm@newy=0%
  \else%
    \herm@dxdy=\herm@dx \multiply\herm@dxdy by 100 \divide\herm@dxdy by \herm@dy%
    \ifnum\herm@dxdy < 0 \multiply\herm@dxdy by -1 \fi%
    \ifnum\herm@dx > 0%
      \ifnum\herm@dy > 0%
        \ifnum\herm@dxdy < 12 \herm@newx=0 \herm@newy=1 \else%
          \ifnum\herm@dxdy < 29 \herm@newx=1 \herm@newy=4 \else%
            \ifnum\herm@dxdy < 41 \herm@newx=1 \herm@newy=3 \else%
              \ifnum\herm@dxdy < 58 \herm@newx=1 \herm@newy=2 \else%
                \ifnum\herm@dxdy < 71 \herm@newx=2 \herm@newy=3 \else%
                  \ifnum\herm@dxdy < 87 \herm@newx=3 \herm@newy=4 \else%
                    \ifnum\herm@dxdy < 116 \herm@newx=1 \herm@newy=1 \else%
                      \ifnum\herm@dxdy < 141 \herm@newx=4 \herm@newy=3 \else%
                        \ifnum\herm@dxdy < 175 \herm@newx=3 \herm@newy=2 \else%
                          \ifnum\herm@dxdy < 250 \herm@newx=2 \herm@newy=1 \else%
                            \ifnum\herm@dxdy < 350 \herm@newx=3 \herm@newy=1 \else%
                              \ifnum\herm@dxdy < 1000 \herm@newx=4 \herm@newy=1 \else \herm@newx=1 \herm@newy=0 \fi%
                            \fi%
                          \fi%
                        \fi%
                      \fi%
                    \fi%
                  \fi%
                \fi%
              \fi%
            \fi%
          \fi%
        \fi
      \else%
        \ifnum\herm@dxdy < 12 \herm@newx=0 \herm@newy=-1 \else%
          \ifnum\herm@dxdy < 29 \herm@newx=1 \herm@newy=-4 \else%
            \ifnum\herm@dxdy < 41 \herm@newx=1 \herm@newy=-3 \else%
              \ifnum\herm@dxdy < 58 \herm@newx=1 \herm@newy=-2 \else%
                \ifnum\herm@dxdy < 71 \herm@newx=2 \herm@newy=-3 \else%
                  \ifnum\herm@dxdy < 87 \herm@newx=3 \herm@newy=-4 \else%
                    \ifnum\herm@dxdy < 116 \herm@newx=1 \herm@newy=-1 \else%
                      \ifnum\herm@dxdy < 141 \herm@newx=4 \herm@newy=-3 \else%
                        \ifnum\herm@dxdy < 175 \herm@newx=3 \herm@newy=-2 \else%
                          \ifnum\herm@dxdy < 250 \herm@newx=2 \herm@newy=-1 \else%
                            \ifnum\herm@dxdy < 350 \herm@newx=3 \herm@newy=-1 \else%
                              \ifnum\herm@dxdy < 1000 \herm@newx=4 \herm@newy=-1 \else \herm@newx=-1 \herm@newy=0 \fi%
                            \fi%
                          \fi%
                        \fi%
                      \fi%
                    \fi%
                  \fi%
                \fi%
              \fi%
            \fi%
          \fi%
        \fi
      \fi%
    \else%
      \ifnum\herm@dy > 0%
        \ifnum\herm@dxdy < 12 \herm@newx=0 \herm@newy=1 \else%
          \ifnum\herm@dxdy < 29 \herm@newx=-1 \herm@newy=4 \else%
            \ifnum\herm@dxdy < 41 \herm@newx=-1 \herm@newy=3 \else%
              \ifnum\herm@dxdy < 58 \herm@newx=-1 \herm@newy=2 \else%
                \ifnum\herm@dxdy < 71 \herm@newx=-2 \herm@newy=3 \else%
                  \ifnum\herm@dxdy < 87 \herm@newx=-3 \herm@newy=4 \else%
                    \ifnum\herm@dxdy < 116 \herm@newx=-1 \herm@newy=1 \else%
                      \ifnum\herm@dxdy < 141 \herm@newx=-4 \herm@newy=3 \else%
                        \ifnum\herm@dxdy < 175 \herm@newx=-3 \herm@newy=2 \else%
                          \ifnum\herm@dxdy < 250 \herm@newx=-2 \herm@newy=1 \else%
                            \ifnum\herm@dxdy < 350 \herm@newx=-3 \herm@newy=1 \else%
                              \ifnum\herm@dxdy < 1000 \herm@newx=-4 \herm@newy=1 \else \herm@newx=1 \herm@newy=0 \fi%
                            \fi%
                          \fi%
                        \fi%
                      \fi%
                    \fi%
                  \fi%
                \fi%
              \fi%
            \fi%
          \fi%
        \fi
      \else%
        \ifnum\herm@dxdy < 12 \herm@newx=0 \herm@newy=-1 \else%
          \ifnum\herm@dxdy < 29 \herm@newx=-1 \herm@newy=-4 \else%
            \ifnum\herm@dxdy < 41 \herm@newx=-1 \herm@newy=-3 \else%
              \ifnum\herm@dxdy < 58 \herm@newx=-1 \herm@newy=-2 \else%
                \ifnum\herm@dxdy < 71 \herm@newx=-2 \herm@newy=-3 \else%
                  \ifnum\herm@dxdy < 87 \herm@newx=-3 \herm@newy=-4 \else%
                    \ifnum\herm@dxdy < 116 \herm@newx=-1 \herm@newy=-1 \else%
                      \ifnum\herm@dxdy < 141 \herm@newx=-4 \herm@newy=-3 \else%
                        \ifnum\herm@dxdy < 175 \herm@newx=-3 \herm@newy=-2 \else%
                          \ifnum\herm@dxdy < 250 \herm@newx=-2 \herm@newy=-1 \else%
                            \ifnum\herm@dxdy < 350 \herm@newx=-3 \herm@newy=-1 \else%
                              \ifnum\herm@dxdy < 1000 \herm@newx=-4 \herm@newy=-1 \else \herm@newx=-1 \herm@newy=0 \fi%
                            \fi%
                          \fi%
                        \fi%
                      \fi%
                    \fi%
                  \fi%
                \fi%
              \fi%
            \fi%
          \fi%
        \fi
      \fi%
    \fi%
  \fi%
  \herm@length=\herm@dx%
  \ifnum\herm@newx = 0 \herm@length=\herm@dy \fi%
  \ifnum\herm@length < 0 \multiply\herm@length by -1 \fi%
  \put(\herm@sx,\herm@sy){\vector(\herm@newx,\herm@newy){\herm@length}}%
  \put(\herm@ex,\herm@ey){%
    \ifnum\herm@dx > 0 %
      \ifnum\herm@dy > 0 %
        \put(-.5,-.2){\makebox(0,0)[tr]{$ #5 $}}%
      \else%
        \put(-0.5,.2){\makebox(0,0)[br]{$ #5 $}}%
      \fi%
    \else%
      \ifnum\herm@dy > 0 %
        \put(.5,-.2){\makebox(0,0)[tl]{$ #5 $}}%
      \else%
        \put(.5,.2){\makebox(0,0)[bl]{$ #5 $}}%
      \fi%
    \fi%
  }%
}%
%
%
% ---  Connection  ---
%
% Draws an arrow from the start to the endpoint and places the label
% an a 'good' place.
%
% \connection2(x1,y1)(x2,y2){label}
%
\newcount\herm@tsx \newcount\herm@tsy \newcount\herm@tex \newcount\herm@tey%
\newcount\herm@tdx \newcount\herm@tdy%
\def\conn(#1,#2)#3{%
  \typeout{Connection between \string#1 and \string#2 ...}
  \newif\ifherm@conerra \herm@conerratrue
  \newif\ifherm@conerrb \herm@conerrbtrue
  \expandafter\if\csname hermobj@#1 \endcsname 1%
    \typeout{   \string#1 found}
    \herm@conerrafalse%
    \herm@tsx=\csname hermobjx@#1 \endcsname%
    \herm@tsy=\csname hermobjy@#1 \endcsname%
    \typeout{      with \the\herm@tsx, \the\herm@tsy}
  \fi%
  \expandafter\if\csname hermobj@#2 \endcsname 1%
    \typeout{   \string#2 found}
    \herm@conerrbfalse
    \herm@tex=\csname hermobjx@#2 \endcsname%
    \herm@tey=\csname hermobjy@#2 \endcsname%
    \typeout{      with \the\herm@tex, \the\herm@tey}
  \fi%
  \ifherm@conerra
    \PackageError {herm-pic}{Undefined object #1 in addvanced connection}{See herm-pic Documentaion.}
  \fi
  \ifherm@conerrb
    \PackageError {herm-pic}{Undefined object #2 in addvanced connection}{See herm-pic Documentaion.}
  \fi
  % comute middle of objects
  \advance\herm@tsx by 2 \advance\herm@tex by 2
  \advance\herm@tsy by 1 \advance\herm@tey by 1
  % compute differences
  \herm@tdx=\herm@tex \herm@tdy=\herm@tey%
  \herm@nsx=\herm@tsx \multiply\herm@nsx by -1 \herm@nsy=\herm@tsy \multiply\herm@nsy by -1%
  \advance\herm@tdx by \herm@nsx \advance\herm@tdy by \herm@nsy%
  \ifnum\herm@tdx < 0 \multiply\herm@tdx by -1 \fi%
  \ifnum\herm@tdy < 0 \multiply\herm@tdy by -1 \fi%
  % set initial start points
  \herm@sx=\herm@tsx%
  \herm@sy=\herm@tsy%
  \herm@ex=\herm@tex%
  \herm@ey=\herm@tey%
  % correct start points
  \typeout{Correct starting points by (\the\herm@tdx, \the\herm@tdy)}
  \ifnum\herm@tdx > \herm@tdy%
    \typeout{Use x correction}
    \ifnum\herm@tsx < \herm@tex%
      \advance\herm@sx by 2 \advance \herm@ex by -2%
    \fi%
    \ifnum\herm@tsx > \herm@tex%
      \advance\herm@sx by -2 \advance \herm@ex by 2%
    \fi%
  %\fi%
  \else
  %\ifnum\herm@tdx < \herm@tdy%
    \typeout{Use y correction}
    \ifnum\herm@tsy < \herm@tey%
      \advance\herm@sy by 1 \advance \herm@ey by -1%
    \fi%
    \ifnum\herm@tsy > \herm@tey%
      \advance\herm@sy by -1 \advance \herm@ey by 1%
    \fi%
  \fi%
  % try to compute \vector parameter
  \herm@dx=\herm@ex \herm@dy=\herm@ey%
  \herm@nsx=\herm@sx \multiply\herm@nsx by -1 \herm@nsy=\herm@sy \multiply\herm@nsy by -1%
  \advance\herm@dx by \herm@nsx \advance\herm@dy by \herm@nsy%
  \ifnum\herm@dy = 0 \ifnum\herm@dx > 0 \herm@newx=1 \else \herm@newx=-1 \fi \herm@newy=0%
  \else%
    \herm@dxdy=\herm@dx \multiply\herm@dxdy by 100 \divide\herm@dxdy by \herm@dy%
    \ifnum\herm@dxdy < 0 \multiply\herm@dxdy by -1 \fi%
    \ifnum\herm@dx > 0%
      \ifnum\herm@dy > 0%
        \ifnum\herm@dxdy < 12 \herm@newx=0 \herm@newy=1 \else%
          \ifnum\herm@dxdy < 29 \herm@newx=1 \herm@newy=4 \else%
            \ifnum\herm@dxdy < 41 \herm@newx=1 \herm@newy=3 \else%
              \ifnum\herm@dxdy < 58 \herm@newx=1 \herm@newy=2 \else%
                \ifnum\herm@dxdy < 71 \herm@newx=2 \herm@newy=3 \else%
                  \ifnum\herm@dxdy < 87 \herm@newx=3 \herm@newy=4 \else%
                    \ifnum\herm@dxdy < 116 \herm@newx=1 \herm@newy=1 \else%
                      \ifnum\herm@dxdy < 141 \herm@newx=4 \herm@newy=3 \else%
                        \ifnum\herm@dxdy < 175 \herm@newx=3 \herm@newy=2 \else%
                          \ifnum\herm@dxdy < 250 \herm@newx=2 \herm@newy=1 \else%
                            \ifnum\herm@dxdy < 350 \herm@newx=3 \herm@newy=1 \else%
                              \ifnum\herm@dxdy < 1000 \herm@newx=4 \herm@newy=1 \else \herm@newx=1 \herm@newy=0 \fi%
                            \fi%
                          \fi%
                        \fi%
                      \fi%
                    \fi%
                  \fi%
                \fi%
              \fi%
            \fi%
          \fi%
        \fi
      \else%
        \ifnum\herm@dxdy < 12 \herm@newx=0 \herm@newy=-1 \else%
          \ifnum\herm@dxdy < 29 \herm@newx=1 \herm@newy=-4 \else%
            \ifnum\herm@dxdy < 41 \herm@newx=1 \herm@newy=-3 \else%
              \ifnum\herm@dxdy < 58 \herm@newx=1 \herm@newy=-2 \else%
                \ifnum\herm@dxdy < 71 \herm@newx=2 \herm@newy=-3 \else%
                  \ifnum\herm@dxdy < 87 \herm@newx=3 \herm@newy=-4 \else%
                    \ifnum\herm@dxdy < 116 \herm@newx=1 \herm@newy=-1 \else%
                      \ifnum\herm@dxdy < 141 \herm@newx=4 \herm@newy=-3 \else%
                        \ifnum\herm@dxdy < 175 \herm@newx=3 \herm@newy=-2 \else%
                          \ifnum\herm@dxdy < 250 \herm@newx=2 \herm@newy=-1 \else%
                            \ifnum\herm@dxdy < 350 \herm@newx=3 \herm@newy=-1 \else%
                              \ifnum\herm@dxdy < 1000 \herm@newx=4 \herm@newy=-1 \else \herm@newx=-1 \herm@newy=0 \fi%
                            \fi%
                          \fi%
                        \fi%
                      \fi%
                    \fi%
                  \fi%
                \fi%
              \fi%
            \fi%
          \fi%
        \fi
      \fi%
    \else%
      \ifnum\herm@dy > 0%
        \ifnum\herm@dxdy < 12 \herm@newx=0 \herm@newy=1 \else%
          \ifnum\herm@dxdy < 29 \herm@newx=-1 \herm@newy=4 \else%
            \ifnum\herm@dxdy < 41 \herm@newx=-1 \herm@newy=3 \else%
              \ifnum\herm@dxdy < 58 \herm@newx=-1 \herm@newy=2 \else%
                \ifnum\herm@dxdy < 71 \herm@newx=-2 \herm@newy=3 \else%
                  \ifnum\herm@dxdy < 87 \herm@newx=-3 \herm@newy=4 \else%
                    \ifnum\herm@dxdy < 116 \herm@newx=-1 \herm@newy=1 \else%
                      \ifnum\herm@dxdy < 141 \herm@newx=-4 \herm@newy=3 \else%
                        \ifnum\herm@dxdy < 175 \herm@newx=-3 \herm@newy=2 \else%
                          \ifnum\herm@dxdy < 250 \herm@newx=-2 \herm@newy=1 \else%
                            \ifnum\herm@dxdy < 350 \herm@newx=-3 \herm@newy=1 \else%
                              \ifnum\herm@dxdy < 1000 \herm@newx=-4 \herm@newy=1 \else \herm@newx=1 \herm@newy=0 \fi%
                            \fi%
                          \fi%
                        \fi%
                      \fi%
                    \fi%
                  \fi%
                \fi%
              \fi%
            \fi%
          \fi%
        \fi
      \else%
        \ifnum\herm@dxdy < 12 \herm@newx=0 \herm@newy=-1 \else%
          \ifnum\herm@dxdy < 29 \herm@newx=-1 \herm@newy=-4 \else%
            \ifnum\herm@dxdy < 41 \herm@newx=-1 \herm@newy=-3 \else%
              \ifnum\herm@dxdy < 58 \herm@newx=-1 \herm@newy=-2 \else%
                \ifnum\herm@dxdy < 71 \herm@newx=-2 \herm@newy=-3 \else%
                  \ifnum\herm@dxdy < 87 \herm@newx=-3 \herm@newy=-4 \else%
                    \ifnum\herm@dxdy < 116 \herm@newx=-1 \herm@newy=-1 \else%
                      \ifnum\herm@dxdy < 141 \herm@newx=-4 \herm@newy=-3 \else%
                        \ifnum\herm@dxdy < 175 \herm@newx=-3 \herm@newy=-2 \else%
                          \ifnum\herm@dxdy < 250 \herm@newx=-2 \herm@newy=-1 \else%
                            \ifnum\herm@dxdy < 350 \herm@newx=-3 \herm@newy=-1 \else%
                              \ifnum\herm@dxdy < 1000 \herm@newx=-4 \herm@newy=-1 \else \herm@newx=-1 \herm@newy=0 \fi%
                            \fi%
                          \fi%
                        \fi%
                      \fi%
                    \fi%
                  \fi%
                \fi%
              \fi%
            \fi%
          \fi%
        \fi
      \fi%
    \fi%
  \fi%
  \herm@length=\herm@dx%
  \ifnum\herm@newx = 0 \herm@length=\herm@dy \fi%
  \ifnum\herm@length < 0 \multiply\herm@length by -1 \fi%
  \put(\herm@sx,\herm@sy){\vector(\herm@newx,\herm@newy){\herm@length}}%
  \put(\herm@ex,\herm@ey){%
    \ifnum\herm@dx > 0 %
      \ifnum\herm@dy > 0 %
        \put(-.5,-.2){\makebox(0,0)[tr]{$ #3 $}}%
      \else%
        \put(-0.5,.2){\makebox(0,0)[br]{$ #3 $}}%
      \fi%
    \else%
      \ifnum\herm@dy > 0 %
        \put(.5,-.2){\makebox(0,0)[tl]{$ #3 $}}%
      \else%
        \put(.5,.2){\makebox(0,0)[bl]{$ #3 $}}%
      \fi%
    \fi%
  }%
}%
%
% ---   END OF MODULE   ---
